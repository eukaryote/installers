#!/usr/bin/env bash

set -uo pipefail

REPOS="${REPOS:-$HOME/repos}"
GIT_BASE="${GIT_BASE:-/opt/git}"

# Run a build command with minimal environment, limited to
# LANG, LANGUAGE, and a minimal PATH containing just /usr/bin and /bin,
# and echoing the exact command to be executed before executing it.
run_clean() {
    local -r language="${LANGUAGE:-en_US}"
    local -r lang="${LANG:-${language}.UTF-8}"

    echo env -i PATH=/usr/bin:/bin LANGUAGE="${language}" LANG="${lang}" "$@"
    env -i PATH=/usr/bin:/bin LANGUAGE="${language}" LANG="${lang}" "$@"
}

install_git_main() {
    local -r version="${1:?version param is required}"
    local -r install_dir="${GIT_BASE}/${version}"

    cd "${REPOS}/git" || {
        local -r rc=$?
        >&2 echo "ERROR: Git repo not found at expected location: ${REPOS}/git"
        return $rc
    }
    git checkout "v${version}" || {
        local -r rc=$?
        >&2 echo "ERROR: error checking out git version v${version}"
        return $rc
    }
    run_clean make CURLDIR="${REPOS}/curl" prefix="${install_dir}" all doc info || return
    run_clean make prefix="${install_dir}" install install-doc install-html install-info || return
}

install_git_main "$@"
